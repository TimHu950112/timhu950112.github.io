<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»å­æ›¸é é¢ç€è¦½å™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .image-container {
            text-align: center;
            margin: 20px 0;
        }

        #bookImage {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 0 20px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .nav-btn {
            background-color: #007bff;
            color: white;
        }

        .nav-btn:hover {
            background-color: #0056b3;
        }

        .nav-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .page-info {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .url-display {
            margin: 20px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            word-break: break-all;
            font-family: monospace;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .download-section {
            margin: 30px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .download-section h3 {
            margin-top: 0;
            color: #333;
        }

        .download-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .range-inputs {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .range-inputs label {
            font-weight: bold;
            color: #555;
        }

        .range-inputs input {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            width: 80px;
        }

        .download-actions {
            display: flex;
            gap: 10px;
        }

        .download-btn {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            background-color: #28a745;
            color: white;
        }

        .download-btn:hover {
            background-color: #218838;
        }

        .download-btn.cancel {
            background-color: #dc3545;
        }

        .download-btn.cancel:hover {
            background-color: #c82333;
        }

        .download-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .progress-container {
            margin-top: 20px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            color: #555;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
            width: 0%;
        }

        .download-links {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .download-links h4 {
            margin-top: 0;
            color: #495057;
        }

        .download-link {
            display: block;
            margin: 8px 0;
            padding: 8px 12px;
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            text-decoration: none;
            color: #007bff;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .download-link:hover {
            background-color: #f8f9fa;
            text-decoration: underline;
        }

        .mode-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .mode-btn {
            padding: 10px 20px;
            font-size: 16px;
            border: 2px solid #007bff;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            background-color: white;
            color: #007bff;
        }

        .mode-btn:hover {
            background-color: #f8f9fa;
        }

        .mode-btn.active {
            background-color: #007bff;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>é›»å­æ›¸é é¢ç€è¦½å™¨</h1>

        <div class="controls">
            <button class="nav-btn" id="prevBtn" onclick="changePage(-1)">â—€ ä¸Šä¸€é </button>
            <div class="page-info">
                é æ•¸: <span id="currentPage">4-5</span>
            </div>
            <button class="nav-btn" id="nextBtn" onclick="changePage(1)">ä¸‹ä¸€é  â–¶</button>
        </div>

        <div class="mode-controls">
            <button class="mode-btn" id="questionBtn" onclick="switchMode('question')">ğŸ“– é¡Œç›®</button>
            <button class="mode-btn active" id="answerBtn" onclick="switchMode('answer')">âœ… ç­”æ¡ˆ</button>
        </div>

        <div class="download-section">
            <h3>æ‰¹é‡ä¸‹è¼‰</h3>
            <div class="download-controls">
                <div class="range-inputs">
                    <label for="startPage">èµ·å§‹é :</label>
                    <input type="number" id="startPage" min="2" step="2" value="2" onchange="validatePageRange()">

                    <label for="endPage">çµæŸé :</label>
                    <input type="number" id="endPage" min="2" step="2" value="10" onchange="validatePageRange()">
                </div>

                <div class="download-actions">
                    <button class="download-btn" id="downloadBtn" onclick="startDownload()">ğŸ“¥ æ‰¹é‡ä¸‹è¼‰</button>
                    <button class="download-btn" id="zipDownloadBtn" onclick="downloadAsZip()" style="background-color: #ffc107; color: #212529;">ğŸ“¦ ä¸‹è¼‰ZIP</button>
                    <button class="download-btn" id="generateLinksBtn" onclick="generateDownloadLinks()" style="background-color: #17a2b8;">ğŸ”— ç”Ÿæˆä¸‹è¼‰é€£çµ</button>
                    <button class="download-btn cancel" id="cancelBtn" onclick="cancelDownload()" style="display: none;">âŒ å–æ¶ˆä¸‹è¼‰</button>
                </div>
            </div>

            <div class="progress-container" id="progressContainer" style="display: none;">
                <div class="progress-info">
                    <span id="progressText">æº–å‚™ä¸‹è¼‰...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <div class="download-links" id="downloadLinks" style="display: none;">
                <h4>ä¸‹è¼‰é€£çµ (å³éµå¦å­˜æ–°æª”)</h4>
                <div id="linksList"></div>
            </div>
        </div>

        <div class="image-container">
            <div id="loadingMsg" class="loading">è¼‰å…¥ä¸­...</div>
            <img id="bookImage" style="display: none;" alt="é›»å­æ›¸é é¢" onload="imageLoaded()" onerror="imageError()">
        </div>

        <div class="url-display">
            <strong>ç•¶å‰ URL:</strong><br>
            <span id="currentUrl"></span>
        </div>
    </div>

    <script>
        // åŸºç¤ URL æ¨¡æ¿
        const questionBaseUrl = "https://digitalmaster.knsh.com.tw/ebooks/%E5%9C%8B%E4%B8%AD%E8%BC%94%E6%9D%90/Books/114%E4%B8%8A/02_%E8%8B%B1%E8%AA%9E/03_%E5%96%AE%E5%86%8A3%E5%B9%B4%E7%B4%9A/01_%E7%B6%B2%E9%A0%81%E9%9B%BB%E5%AD%90%E6%9B%B8/UK11491MKSEN/Resource/SystemResource/knsh_book/EditRes/Resource/studetnt%20ok/";
        const answerBaseUrl = "https://digitalmaster.knsh.com.tw/ebooks/%E5%9C%8B%E4%B8%AD%E8%BC%94%E6%9D%90/Books/114%E4%B8%8A/02_%E8%8B%B1%E8%AA%9E/03_%E5%96%AE%E5%86%8A3%E5%B9%B4%E7%B4%9A/01_%E7%B6%B2%E9%A0%81%E9%9B%BB%E5%AD%90%E6%9B%B8/UK11491MKSEN/Resource/SystemResource/knsh_book/EditRes/Resource/teacher%20ok/";

        // ç•¶å‰é é¢ä¿¡æ¯
        let currentPageNum = 4;
        let currentSubPage = 5;
        let currentAnswerPage = 54; // ç­”æ¡ˆé ç¢¼ï¼ˆå–®ä¸€é é¢ï¼‰
        let currentMode = 'question'; // 'question' æˆ– 'answer'

        // é é¢ç¯„åœè¨­å®š
        const minPage = 2; // æœ€å°å¾ 2-3 é–‹å§‹
        const maxPage = 100; // å¯æ ¹æ“šå¯¦éš›æƒ…æ³èª¿æ•´

        function updatePageDisplay() {
            if (currentMode === 'question') {
                const pageStr = `${currentPageNum}-${currentSubPage}`;
                document.getElementById('currentPage').textContent = pageStr;
                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                document.getElementById('prevBtn').disabled = (currentPageNum <= minPage);
                document.getElementById('nextBtn').disabled = (currentPageNum >= maxPage);
            } else {
                document.getElementById('currentPage').textContent = `ç­”æ¡ˆ ${currentAnswerPage}`;
                // ç­”æ¡ˆæ¨¡å¼çš„æŒ‰éˆ•ç‹€æ…‹
                document.getElementById('prevBtn').disabled = (currentAnswerPage <= 1);
                document.getElementById('nextBtn').disabled = (currentAnswerPage >= 200); // å‡è¨­æœ€å¤§ç­”æ¡ˆé æ•¸
            }
        }

        function loadImage() {
            let fullUrl;

            if (currentMode === 'question') {
                const pageStr = `${currentPageNum}-${currentSubPage}`;
                fullUrl = questionBaseUrl + pageStr + ".png";
            } else {
                fullUrl = answerBaseUrl + currentAnswerPage + ".png";
            }

            document.getElementById('currentUrl').textContent = fullUrl;
            document.getElementById('loadingMsg').style.display = 'block';
            document.getElementById('bookImage').style.display = 'none';

            const img = document.getElementById('bookImage');
            img.src = fullUrl;
        }

        function imageLoaded() {
            document.getElementById('loadingMsg').style.display = 'none';
            document.getElementById('bookImage').style.display = 'block';
        }

        function imageError() {
            document.getElementById('loadingMsg').textContent = 'åœ–ç‰‡è¼‰å…¥å¤±æ•—';
            document.getElementById('bookImage').style.display = 'none';
        }

        function changePage(direction) {
            if (currentMode === 'question') {
                if (direction > 0) {
                    // ä¸‹ä¸€é ï¼š4-5 â†’ 6-7 â†’ 8-9 â†’ 10-11
                    currentPageNum += 2;
                    currentSubPage += 2;
                } else {
                    // ä¸Šä¸€é ï¼š8-9 â†’ 6-7 â†’ 4-5 â†’ 2-3
                    if (currentPageNum > minPage) {
                        currentPageNum -= 2;
                        currentSubPage -= 2;
                    }
                }
            } else {
                // ç­”æ¡ˆæ¨¡å¼ï¼šå–®é å°èˆª
                if (direction > 0) {
                    if (currentAnswerPage < 200) {
                        currentAnswerPage++;
                    }
                } else {
                    if (currentAnswerPage > 1) {
                        currentAnswerPage--;
                    }
                }
            }

            updatePageDisplay();
            loadImage();
        }

        // åˆ‡æ›æ¨¡å¼
        function switchMode(mode) {
            currentMode = mode;

            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.getElementById('questionBtn').classList.toggle('active', mode === 'question');
            document.getElementById('answerBtn').classList.toggle('active', mode === 'answer');

            updatePageDisplay();
            loadImage();
        }

        // éµç›¤å¿«æ·éµ
        document.addEventListener('keydown', function(event) {
            if (event.key === 'ArrowLeft') {
                changePage(-1);
            } else if (event.key === 'ArrowRight') {
                changePage(1);
            }
        });

        // ä¸‹è¼‰ç›¸é—œè®Šæ•¸
        let downloadCancelled = false;
        let downloadInProgress = false;

        // é©—è­‰é é¢ç¯„åœ
        function validatePageRange() {
            const startPage = parseInt(document.getElementById('startPage').value);
            const endPage = parseInt(document.getElementById('endPage').value);

            // ç¢ºä¿æ˜¯å¶æ•¸
            if (startPage % 2 !== 0) {
                document.getElementById('startPage').value = startPage + 1;
            }
            if (endPage % 2 !== 0) {
                document.getElementById('endPage').value = endPage + 1;
            }

            // ç¢ºä¿èµ·å§‹é  <= çµæŸé 
            if (startPage > endPage) {
                document.getElementById('endPage').value = startPage;
            }
        }

        // ç”Ÿæˆé é¢åˆ—è¡¨ (2-3, 4-5, 6-7, ...)
        function generatePageList(start, end) {
            const pages = [];
            for (let i = start; i <= end; i += 2) {
                pages.push(`${i}-${i + 1}`);
            }
            return pages;
        }

        // ä¸‹è¼‰å–®å¼µåœ–ç‰‡ (æ”¹ç”¨ç›´æ¥é€£çµæ–¹å¼)
        async function downloadImage(pageStr) {
            return new Promise((resolve, reject) => {
                const url = questionBaseUrl + pageStr + ".png";

                // å‰µå»ºéš±è—çš„ iframe ä¾†è§¸ç™¼ä¸‹è¼‰
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = url;
                document.body.appendChild(iframe);

                // ä¹Ÿå‰µå»ºç›´æ¥ä¸‹è¼‰é€£çµä½œç‚ºå‚™ç”¨
                const link = document.createElement('a');
                link.href = url;
                link.download = `page_${pageStr}.png`;
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // æ¸…ç† iframe
                setTimeout(() => {
                    if (iframe.parentNode) {
                        document.body.removeChild(iframe);
                    }
                    resolve();
                }, 1000);
            });
        }

        // é–‹å§‹æ‰¹é‡ä¸‹è¼‰
        async function startDownload() {
            if (downloadInProgress) return;

            const startPage = parseInt(document.getElementById('startPage').value);
            const endPage = parseInt(document.getElementById('endPage').value);

            if (startPage > endPage) {
                alert('èµ·å§‹é ä¸èƒ½å¤§æ–¼çµæŸé ï¼');
                return;
            }

            downloadInProgress = true;
            downloadCancelled = false;

            // é¡¯ç¤ºé€²åº¦æ¢
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('downloadBtn').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'inline-block';

            const pageList = generatePageList(startPage, endPage);
            const totalPages = pageList.length;

            document.getElementById('progressText').textContent = `æº–å‚™ä¸‹è¼‰ ${totalPages} é ...`;
            document.getElementById('progressPercent').textContent = '0%';
            document.getElementById('progressFill').style.width = '0%';

            let completed = 0;

            for (let i = 0; i < pageList.length; i++) {
                if (downloadCancelled) break;

                const pageStr = pageList[i];
                document.getElementById('progressText').textContent = `ä¸‹è¼‰ä¸­: ${pageStr} (${i + 1}/${totalPages})`;

                try {
                    await downloadImage(pageStr);
                    completed++;

                    const progress = (completed / totalPages) * 100;
                    document.getElementById('progressPercent').textContent = `${Math.round(progress)}%`;
                    document.getElementById('progressFill').style.width = `${progress}%`;

                    // æ·»åŠ å°å»¶é²é¿å…ç€è¦½å™¨é˜»å¡
                    await new Promise(resolve => setTimeout(resolve, 500));
                } catch (error) {
                    console.error(`ä¸‹è¼‰å¤±æ•—: ${pageStr}`, error);
                }
            }

            // å®Œæˆä¸‹è¼‰
            if (!downloadCancelled) {
                document.getElementById('progressText').textContent = `ä¸‹è¼‰å®Œæˆï¼å…± ${completed} é `;
                document.getElementById('progressPercent').textContent = '100%';
                document.getElementById('progressFill').style.width = '100%';
            } else {
                document.getElementById('progressText').textContent = `ä¸‹è¼‰å·²å–æ¶ˆ (å·²ä¸‹è¼‰ ${completed} é )`;
            }

            // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
            setTimeout(() => {
                document.getElementById('progressContainer').style.display = 'none';
                document.getElementById('downloadBtn').style.display = 'inline-block';
                document.getElementById('cancelBtn').style.display = 'none';
                downloadInProgress = false;
            }, 3000);
        }

        // å–æ¶ˆä¸‹è¼‰
        function cancelDownload() {
            downloadCancelled = true;
        }

        // ç”Ÿæˆä¸‹è¼‰é€£çµåˆ—è¡¨
        function generateDownloadLinks() {
            const startPage = parseInt(document.getElementById('startPage').value);
            const endPage = parseInt(document.getElementById('endPage').value);

            if (startPage > endPage) {
                alert('èµ·å§‹é ä¸èƒ½å¤§æ–¼çµæŸé ï¼');
                return;
            }

            const pageList = generatePageList(startPage, endPage);
            const linksList = document.getElementById('linksList');
            linksList.innerHTML = '';

            pageList.forEach(pageStr => {
                const url = questionBaseUrl + pageStr + ".png";
                const link = document.createElement('a');
                link.href = url;
                link.className = 'download-link';
                link.target = '_blank';
                link.download = `page_${pageStr}.png`;
                link.textContent = `ä¸‹è¼‰é é¢ ${pageStr}`;
                linksList.appendChild(link);
            });

            document.getElementById('downloadLinks').style.display = 'block';
        }

        // ZIP ä¸‹è¼‰åŠŸèƒ½
        async function downloadAsZip() {
            if (downloadInProgress) return;

            const startPage = parseInt(document.getElementById('startPage').value);
            const endPage = parseInt(document.getElementById('endPage').value);

            if (startPage > endPage) {
                alert('èµ·å§‹é ä¸èƒ½å¤§æ–¼çµæŸé ï¼');
                return;
            }

            downloadInProgress = true;
            downloadCancelled = false;

            // é¡¯ç¤ºé€²åº¦æ¢
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('zipDownloadBtn').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'inline-block';

            const pageList = generatePageList(startPage, endPage);
            const totalPages = pageList.length;
            const zip = new JSZip();

            document.getElementById('progressText').textContent = `æº–å‚™æ‰“åŒ… ${totalPages} é ...`;
            document.getElementById('progressPercent').textContent = '0%';
            document.getElementById('progressFill').style.width = '0%';

            let completed = 0;

            try {
                for (let i = 0; i < pageList.length; i++) {
                    if (downloadCancelled) break;

                    const pageStr = pageList[i];
                    document.getElementById('progressText').textContent = `è™•ç†ä¸­: ${pageStr} (${i + 1}/${totalPages})`;

                    try {
                        const imageBlob = await fetchImageAsBlob(pageStr);
                        if (imageBlob) {
                            zip.file(`page_${pageStr}.png`, imageBlob);
                            completed++;

                            const progress = (completed / totalPages) * 100;
                            document.getElementById('progressPercent').textContent = `${Math.round(progress)}%`;
                            document.getElementById('progressFill').style.width = `${progress}%`;
                        }
                    } catch (error) {
                        console.error(`è™•ç†å¤±æ•—: ${pageStr}`, error);
                    }

                    // æ·»åŠ å°å»¶é²é¿å…ç€è¦½å™¨é˜»å¡
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                if (!downloadCancelled && completed > 0) {
                    document.getElementById('progressText').textContent = 'æ­£åœ¨ç”ŸæˆZIPæª”æ¡ˆ...';

                    const zipBlob = await zip.generateAsync({
                        type: "blob",
                        compression: "DEFLATE",
                        compressionOptions: { level: 6 }
                    });

                    // ä¸‹è¼‰ZIPæª”æ¡ˆ
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(zipBlob);
                    link.download = `pages_${startPage}-${endPage}.zip`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);

                    document.getElementById('progressText').textContent = `ZIPä¸‹è¼‰å®Œæˆï¼å…±æ‰“åŒ… ${completed} é `;
                    document.getElementById('progressPercent').textContent = '100%';
                    document.getElementById('progressFill').style.width = '100%';
                } else if (downloadCancelled) {
                    document.getElementById('progressText').textContent = `ä¸‹è¼‰å·²å–æ¶ˆ (å·²è™•ç† ${completed} é )`;
                } else {
                    document.getElementById('progressText').textContent = 'æ²’æœ‰æˆåŠŸä¸‹è¼‰ä»»ä½•é é¢';
                }

            } catch (error) {
                console.error('ZIPç”Ÿæˆå¤±æ•—:', error);
                document.getElementById('progressText').textContent = 'ZIPç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦';
            }

            // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
            setTimeout(() => {
                document.getElementById('progressContainer').style.display = 'none';
                document.getElementById('zipDownloadBtn').style.display = 'inline-block';
                document.getElementById('cancelBtn').style.display = 'none';
                downloadInProgress = false;
            }, 3000);
        }

        // ç²å–åœ–ç‰‡ç‚ºBlob
        async function fetchImageAsBlob(pageStr) {
            return new Promise((resolve, reject) => {
                const url = questionBaseUrl + pageStr + ".png";

                fetch(url, { mode: 'cors' })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.blob();
                    })
                    .then(blob => resolve(blob))
                    .catch(error => {
                        console.warn(`ç„¡æ³•ç²å–é é¢: ${pageStr}`, error);
                        // å˜—è©¦ä½¿ç”¨ Image + Canvas æ–¹å¼
                        const img = new Image();
                        img.crossOrigin = 'anonymous';
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);
                            canvas.toBlob(resolve, 'image/png');
                        };
                        img.onerror = () => resolve(null);
                        img.src = url;
                    });
            });
        }

        // åˆå§‹åŒ–
        updatePageDisplay();
        loadImage();
    </script>
</body>
</html>